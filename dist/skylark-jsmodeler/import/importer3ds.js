/**
 * skylark-jsmodeler - A version of jsmodeler that ported to running on skylarkjs
 * @author Hudaokeji, Inc.
 * @version v0.9.0
 * @link https://github.com/skylark-integration/skylark-jsmodeler/
 * @license MIT
 */
define(["../core/jsm"],function(n){return n.Read3dsFile=function(e,t){function o(n,e){void 0!==t.onLog&&null!==t.onLog&&t.onLog(n,e)}function a(n,e,o){void 0!==t.onVertex&&null!==t.onVertex&&t.onVertex(n,e,o)}function i(n,e){void 0!==t.onTextureVertex&&null!==t.onTextureVertex&&t.onTextureVertex(n,e)}function r(n,e,o,a){void 0!==t.onFace&&null!==t.onFace&&t.onFace(n,e,o,a)}function u(n,e){void 0!==t.onFaceMaterial&&null!==t.onFaceMaterial&&t.onFaceMaterial(n,e)}function d(n,e){void 0!==t.onFaceSmoothingGroup&&null!==t.onFaceSmoothingGroup&&t.onFaceSmoothingGroup(n,e)}function c(n,e){e(n.ReadUnsignedInteger16(),n.ReadUnsignedInteger32())}function l(n,e){n.Skip(e-6)}function T(n,e){return n.GetPosition()+e-6}function s(n){for(var e="",t=0,o=0;o<64&&0!==(t=n.ReadCharacter());)e+=String.fromCharCode(t),o+=1;return e}function f(n){var e,t=[];for(e=0;e<3;e++)t[e]=n.ReadFloat32();return t}function R(n,e,t){for(;n.GetPosition()<=e-6;)c(n,t)}void 0!==t&&null!==t||(t={});!function(n,e){function c(n,t,o){var a=[0,0,0],i=T(n,o),r=!1;return R(n,i,function(t,o){t==e.MAT_COLOR?r||(a[0]=n.ReadUnsignedCharacter()/255,a[1]=n.ReadUnsignedCharacter()/255,a[2]=n.ReadUnsignedCharacter()/255):t==e.MAT_LIN_COLOR?(a[0]=n.ReadUnsignedCharacter()/255,a[1]=n.ReadUnsignedCharacter()/255,a[2]=n.ReadUnsignedCharacter()/255,r=!0):t==e.MAT_COLOR_F?r||(a[0]=n.ReadFloat32(),a[1]=n.ReadFloat32(),a[2]=n.ReadFloat32()):t==e.MAT_LIN_COLOR_F?(a[0]=n.ReadFloat32(),a[1]=n.ReadFloat32(),a[2]=n.ReadFloat32(),r=!0):l(n,o)}),a}function A(n,t,o){var a=0,i=T(n,o);return R(n,i,function(t,o){t==e.PERCENTAGE?a=n.ReadUnsignedInteger16()/100:t==e.PERCENTAGE_F?a=n.ReadFloat32():l(n,o)}),a}function g(n,a,i){o("Read material chunk ("+a.toString(16)+", "+i+")",2);var r={},u=T(n,i);R(n,u,function(t,u){t==e.MAT_NAME?(o("Read material name chunk ("+a.toString(16)+", "+i+")",3),r.name=s(n)):t==e.MAT_AMBIENT?(o("Read material ambient chunk ("+a.toString(16)+", "+i+")",3),r.ambient=c(n,0,u)):t==e.MAT_DIFFUSE?(o("Read material diffuse chunk ("+a.toString(16)+", "+i+")",3),r.diffuse=c(n,0,u)):t==e.MAT_SPECULAR?(o("Read material specular chunk ("+a.toString(16)+", "+i+")",3),r.specular=c(n,0,u)):t==e.MAT_SHININESS?(o("Read material shininess chunk ("+a.toString(16)+", "+i+")",3),r.shininess=A(n,0,u)):t==e.MAT_SHININESS_STRENGTH?(o("Read material shininess strength chunk ("+a.toString(16)+", "+i+")",3),r.shininessStrength=A(n,0,u)):t==e.MAT_TRANSPARENCY?(o("Read material transparency chunk ("+a.toString(16)+", "+i+")",3),r.transparency=A(n,0,u)):t==e.MAT_TEXMAP?(o("Read material texture map chunk ("+a.toString(16)+", "+i+")",3),function(n,t,o,a){a.texture=null,a.offset=[0,0],a.scale=[1,1],a.rotation=0;var i=T(n,o);R(n,i,function(t,o){t==e.MAT_TEXMAP_NAME?a.texture=s(n):t==e.MAT_TEXMAP_UOFFSET?a.offset[0]=n.ReadFloat32():t==e.MAT_TEXMAP_VOFFSET?a.offset[1]=n.ReadFloat32():t==e.MAT_TEXMAP_USCALE?a.scale[0]=n.ReadFloat32():t==e.MAT_TEXMAP_VSCALE?a.scale[1]=n.ReadFloat32():t==e.MAT_TEXMAP_ROTATION?a.rotation=n.ReadFloat32():l(n,o)})}(n,0,u,r)):(o("Skip chunk ("+t.toString(16)+", "+u+")",3),l(n,u))}),function(n){void 0!==t.onMaterial&&null!==t.onMaterial&&t.onMaterial(n)}(r)}function M(n,t,a){o("Read faces chunk ("+t.toString(16)+", "+a+")",4);var i,c=T(n,a),f=n.ReadUnsignedInteger16();for(i=0;i<f;i++)r(n.ReadUnsignedInteger16(),n.ReadUnsignedInteger16(),n.ReadUnsignedInteger16(),n.ReadUnsignedInteger16());R(n,c,function(t,a){t==e.TRI_MATERIAL?function(n,e,t){o("Read face materials chunk ("+e.toString(16)+", "+t+")",5);var a,i=s(n),r=n.ReadUnsignedInteger16();for(a=0;a<r;a++)u(n.ReadUnsignedInteger16(),i)}(n,t,a):t==e.TRI_SMOOTH?function(n,e,t,a){var i;for(o("Read face smoothing groups chunk ("+t.toString(16)+", "+a+")",5),i=0;i<e;i++)d(i,n.ReadUnsignedInteger32())}(n,f,t,a):(o("Skip chunk ("+t.toString(16)+", "+a+")",5),l(n,a))})}function E(n,e,a){o("Read transformation chunk ("+e.toString(16)+", "+a+")",4);var i,r,u=[];for(i=0;i<4;i++){for(r=0;r<3;r++)u.push(n.ReadFloat32());i<3?u.push(0):u.push(1)}!function(n){void 0!==t.onTransformation&&null!==t.onTransformation&&t.onTransformation(n)}(u)}function S(n,r,u,d){o("Read mesh chunk ("+r+", "+u.toString(16)+", "+d+")",3),function(n){void 0!==t.onMesh&&null!==t.onMesh&&t.onMesh(n)}(r);var c=T(n,d);R(n,c,function(t,r){t==e.TRI_VERTEX?function(n,e,t){o("Read vertices chunk ("+e.toString(16)+", "+t+")",4);var i,r=n.ReadUnsignedInteger16();for(i=0;i<r;i++)a(n.ReadFloat32(),n.ReadFloat32(),n.ReadFloat32())}(n,t,r):t==e.TRI_TEXVERTEX?function(n,e,t){o("Read texture vertices chunk ("+e.toString(16)+", "+t+")",4);var a,r=n.ReadUnsignedInteger16();for(a=0;a<r;a++)i(n.ReadFloat32(),n.ReadFloat32())}(n,t,r):t==e.TRI_FACE?M(n,t,r):t==e.TRI_TRANSFORMATION?E(n,t,r):(o("Skip chunk ("+t.toString(16)+", "+r+")",4),l(n,r))})}function I(n,t,a){o("Read object chunk ("+t.toString(16)+", "+a+")",2);var i=T(n,a),r=s(n);R(n,i,function(t,a){t==e.OBJ_TRIMESH?S(n,r,t,a):t==e.OBJ_LIGHT?function(n,e,t,a){o("Skip light chunk ("+e+", "+t.toString(16)+", "+a+")",3),l(n,a)}(n,r,t,a):t==e.OBJ_CAMERA?function(n,e,t,a){o("Skip camera chunk ("+e+", "+t.toString(16)+", "+a+")",3),l(n,a)}(n,r,t,a):(o("Skip chunk ("+t.toString(16)+", "+a+")",3),l(n,a))})}function _(n,a,i){function r(n,t){var o,a,i,r=[];n.Skip(10);var u=n.ReadInteger32();for(o=0;o<u;o++)n.ReadInteger32(),0!==n.ReadUnsignedInteger16()&&n.ReadFloat32(),a=null,t==e.OBJECT_ROTATION?(i=n.ReadFloat32(),(a=f(n))[3]=i):a=f(n),r.push(a);return r}o("Read object node chunk ("+a.toString(16)+", "+i+")",2);var u={name:"",nodeId:-1,flags:-1,userId:-1,pivot:[0,0,0],positions:[],rotations:[],scales:[]},d=T(n,i);R(n,d,function(t,a){t==e.OBJECT_HIERARCHY?(u.name=s(n),u.flags=n.ReadUnsignedInteger32(),u.userId=n.ReadUnsignedInteger16()):t==e.OBJECT_PIVOT?u.pivot=f(n):t==e.OBJECT_POSITION?u.positions=r(n,e.OBJECT_POSITION):t==e.OBJECT_ROTATION?u.rotations=r(n,e.OBJECT_ROTATION):t==e.OBJECT_SCALE?u.scales=r(n,e.OBJECT_SCALE):t==e.OBJECT_ID?u.nodeId=n.ReadUnsignedInteger16():(o("Skip chunk ("+t.toString(16)+", "+a+")",3),l(n,a))}),function(n){void 0!==t.onObjectNode&&null!==t.onObjectNode&&t.onObjectNode(n)}(u)}function h(n,t,a){o("Read main chunk ("+t.toString(16)+", "+a+")",0);var i=T(n,a);R(n,i,function(t,a){t==e.EDIT3DS?function(n,t,a){o("Read editor chunk ("+t.toString(16)+", "+a+")",1);var i=T(n,a);R(n,i,function(t,a){t==e.EDIT_MATERIAL?g(n,t,a):t==e.EDIT_OBJECT?I(n,t,a):(o("Skip chunk ("+t.toString(16)+", "+a+")",2),l(n,a))})}(n,t,a):t==e.KF3DS?function(n,t,a){o("Read keyframe chunk ("+t.toString(16)+", "+a+")",1);var i=T(n,a);R(n,i,function(t,a){t==e.OBJECT_NODE?_(n,t,a):(o("Skip chunk ("+t.toString(16)+", "+a+")",2),l(n,a))})}(n,t,a):(o("Skip chunk ("+t.toString(16)+", "+a+")",1),l(n,a))})}var v=n.GetByteLength();R(n,v,function(t,a){t==e.MAIN3DS?h(n,t,a):(o("Skip chunk ("+t.toString(16)+", "+a+")",0),l(n,a))})}(new n.BinaryReader(e,!0),{MAIN3DS:19789,EDIT3DS:15677,EDIT_MATERIAL:45055,MAT_NAME:40960,MAT_AMBIENT:40976,MAT_DIFFUSE:40992,MAT_SPECULAR:41008,MAT_SHININESS:41024,MAT_SHININESS_STRENGTH:41025,MAT_TRANSPARENCY:41040,MAT_COLOR_F:16,MAT_COLOR:17,MAT_LIN_COLOR:18,MAT_LIN_COLOR_F:19,MAT_TEXMAP:41472,MAT_TEXMAP_NAME:41728,MAT_TEXMAP_UOFFSET:41816,MAT_TEXMAP_VOFFSET:41818,MAT_TEXMAP_USCALE:41812,MAT_TEXMAP_VSCALE:41814,MAT_TEXMAP_ROTATION:41820,PERCENTAGE:48,PERCENTAGE_F:49,EDIT_OBJECT:16384,OBJ_TRIMESH:16640,OBJ_LIGHT:17920,OBJ_CAMERA:18176,TRI_VERTEX:16656,TRI_TEXVERTEX:16704,TRI_FACE:16672,TRI_TRANSFORMATION:16736,TRI_MATERIAL:16688,TRI_SMOOTH:16720,KF3DS:45056,OBJECT_NODE:45058,OBJECT_HIERARCHY:45072,OBJECT_PIVOT:45075,OBJECT_POSITION:45088,OBJECT_ROTATION:45089,OBJECT_SCALE:45090,OBJECT_ID:45104})},n.Convert3dsToJsonData=function(e,t){function o(n){return void 0!==t.onFileRequested&&null!==t.onFileRequested?t.onFileRequested(n):null}void 0!==t&&null!==t||(t={});var a=new n.TriangleModel,i=null,r={},u={},d={nodes:[],nodeIdToIndex:{}};return n.Read3dsFile(e,{onMaterial:function(n){if(void 0===r[n.name]){var e,t,i,u=a.AddMaterial({name:n.name,ambient:n.ambient,diffuse:n.diffuse,specular:n.specular,shininess:(t=n.shininess,i=n.shininessStrength,void 0===t||null===t?0:void 0===i||null===i?0:t*i),opacity:(e=n.transparency,void 0===e||null===e?1:1-e)}),d=a.GetMaterial(u);if(void 0!==n.texture&&null!==n.texture){var c=o(n.texture);if(null!==c){var l=new window.Blob([c]),T=window.URL.createObjectURL(l);d.texture=T,d.offset=n.offset,d.scale=n.scale,d.rotation=-n.rotation}}r[n.name]=u}},onMesh:function(e){if(void 0===u[e]){var t=a.AddBody(new n.TriangleBody(e));(i=a.GetBody(t)).meshData={faceToMaterial:{},faceToSmoothingGroup:{},objectNodes:[],transformation:null},u[e]=t}},onTransformation:function(n){null!==i&&(i.meshData.transformation=n)},onObjectNode:function(n){var e=d.nodes.length;d.nodes.push(n),d.nodeIdToIndex[n.nodeId]=e;var t=u[n.name];void 0!==t&&a.GetBody(t).meshData.objectNodes.push(e)},onVertex:function(n,e,t){null!==i&&i.AddVertex(n,e,t)},onTextureVertex:function(n,e){null!==i&&i.AddUV(n,e)},onFace:function(n,e,t){null!==i&&i.AddTriangle(n,e,t)},onFaceMaterial:function(n,e){null!==i&&(i.meshData.faceToMaterial[n]=e)},onFaceSmoothingGroup:function(n,e){null!==i&&(i.meshData.faceToSmoothingGroup[n]=e)},onFileRequested:o}),function(e,t,o){function a(e,t,o){function a(n,e){var t,o=e[0],a=e[1],i=e[2];for(t=0;t<4;t++)n[0+t]*=o,n[4+t]*=a,n[8+t]*=i;return n}function i(n,e){var t,o=e[0],a=e[1],i=e[2];for(t=0;t<3;t++)n[12+t]+=n[0+t]*o+n[4+t]*a+n[8+t]*i;return n}function r(e,t){var o,a,i;for(o=0;o<e.VertexCount();o++)a=e.GetVertex(o),i=n.ApplyTransformation(t,a),e.SetVertex(o,i.x,i.y,i.z)}var u,d=e.meshData,c=void 0===(u=d)||null===u?null:u.transformation;if(null!==c){var l=null;l=null!==t?function e(t,o){if(void 0!==t.matrix)return t.matrix;var r,u,d,c=n.MatrixIdentity();if(c=i(c,function(n){return 0===n.positions.length?[0,0,0]:n.positions[0]}(t)),r=c,u=function(e){return 0===e.rotations.length?[0,0,0,0]:function(e){var t=[0,0,0,1],o=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);if(n.IsPositive(o)){var a=-.5*e[3],i=Math.sin(a)/o;t=[i*e[0],i*e[1],i*e[2],Math.cos(a)]}return t}(e.rotations[0])}(t),d=n.MatrixRotationQuaternion(u),c=a(c=n.MatrixMultiply(d,r),function(n){return 0===n.scales.length?[0,0,0,0]:n.scales[0]}(t)),65535!=t.userId){var l=o.nodeIdToIndex[t.userId];if(void 0!==l){var T=e(o.nodes[l],o);c=n.MatrixMultiply(c,T)}}return t.matrix=c,c}(t,o):c;var T=n.MatrixClone(l),s=n.MatrixClone(c),f=n.MatrixInvert(s);if(null!==f){!function(e,t,o){var i=n.MatrixDeterminant(t);if(n.IsNegative(i)){var u=n.MatrixClone(t);a(u,[-1,1,1]),r(e,n.MatrixMultiply(o,u))}}(e,s,f);var R=function(n){return void 0===n||null===n?[0,0,0]:n.pivot}(t);i(T,[-R[0],-R[1],-R[2]]),r(e,n.MatrixMultiply(f,T))}}}function i(n,e,t,o){a(n,e,o),function(n,e){var t,o,a,i,r,u=n.UVCount()==n.VertexCount(),d=n.meshData;for(t=0;t<n.TriangleCount();t++)o=n.GetTriangle(t),u&&(o.u0=o.v0,o.u1=o.v1,o.u2=o.v2),void 0!==(a=d.faceToMaterial[t])&&void 0!==(i=e[a])&&(o.mat=i),void 0!==(r=d.faceToSmoothingGroup[t])&&r>0&&(o.curve=r)}(n,t)}var r,u,d,c,l,T,s,f,R,A,g;for(r=0;r<t.BodyCount();r++)if(0===(c=(d=t.GetBody(r)).meshData).objectNodes.length)i(d,null,o,e);else{for(T=e.nodes[c.objectNodes[0]],u=1;u<c.objectNodes.length;u++)l=e.nodes[c.objectNodes[u]],f=t,R=r+1,A=u+1,g=void 0,(g=d.Clone()).SetName(g.GetName()+" ("+A+")"),R<f.BodyCount()?f.AddBodyToIndex(g,R):f.AddBody(g),(s=g).meshData=d.meshData,i(s,l,o,e),r+=1;i(d,T,o,e)}}(d,a,r),a.Finalize(),n.ConvertTriangleModelToJsonData(a)},n});
//# sourceMappingURL=../sourcemaps/import/importer3ds.js.map
